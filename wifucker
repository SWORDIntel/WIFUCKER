#!/bin/bash
#
# WIFUCKER Unified Launcher
# Integrated WiFi + PBKDF2 + Steganography cracking platform
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="$SCRIPT_DIR/scripts"
TUI_SCRIPT="$SCRIPT_DIR/wifucker_unified_tui.py"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Banner
echo -e "${CYAN}"
cat << "EOF"
╔═══════════════════════════════════════════════════════════════╗
║                                                               ║
║          WIFUCKER - Unified Cracking Platform v2.0            ║
║                                                               ║
║  WiFi WPA/WPA2 + PBKDF2 + Steganography Password Cracking    ║
║                                                               ║
║  Integrated with:                                             ║
║  • Multi-threaded PBKDF2 dictionary attacks                   ║
║  • Context-aware password generation                          ║
║  • Rule-based mutation engine                                 ║
║  • rockyou wordlist integration (14.3M passwords)             ║
║  • Hardware acceleration detection (NPU/NCS2/GPU)             ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝
EOF
echo -e "${NC}"

# Check Python version
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}[✗] Python 3 not found${NC}"
    exit 1
fi

PYTHON_VERSION=$(python3 --version | awk '{print $2}')
echo -e "${GREEN}[✓] Python ${PYTHON_VERSION}${NC}"

# Virtual environment setup
VENV_DIR="$SCRIPT_DIR/venv"
REQUIREMENTS_FILE="$SCRIPT_DIR/requirements.txt"
VENV_PYTHON="$VENV_DIR/bin/python3"
VENV_PIP="$VENV_DIR/bin/pip"

# Function to check if venv is valid
check_venv() {
    if [ -f "$VENV_PYTHON" ] && [ -x "$VENV_PYTHON" ]; then
        # Test if venv python works and can import textual
        if "$VENV_PYTHON" -c "import textual" 2>/dev/null; then
            return 0
        fi
    fi
    return 1
}

# Bootstrap virtual environment
bootstrap_venv() {
    echo -e "${CYAN}[*] Bootstrapping virtual environment...${NC}"

    # Remove broken venv if it exists
    if [ -d "$VENV_DIR" ]; then
        echo -e "${YELLOW}[!] Removing broken virtual environment...${NC}"
        rm -rf "$VENV_DIR"
    fi

    # Create new venv
    echo -e "${CYAN}[*] Creating virtual environment...${NC}"
    python3 -m venv "$VENV_DIR" || {
        echo -e "${RED}[✗] Failed to create virtual environment${NC}"
        exit 1
    }

    # Upgrade pip
    echo -e "${CYAN}[*] Upgrading pip...${NC}"
    "$VENV_PIP" install --upgrade pip --quiet

    # Install dependencies
    if [ -f "$REQUIREMENTS_FILE" ]; then
        echo -e "${CYAN}[*] Installing dependencies from requirements.txt...${NC}"
        set +e
        "$VENV_PIP" install -r "$REQUIREMENTS_FILE" --quiet
        INSTALL_STATUS=$?
        set -e
        if [ $INSTALL_STATUS -ne 0 ]; then
            echo -e "${YELLOW}[!] Some dependencies may have failed, continuing...${NC}"
        fi
    else
        echo -e "${YELLOW}[!] requirements.txt not found, installing minimal dependencies...${NC}"
        "$VENV_PIP" install textual rich --quiet
    fi

    echo -e "${GREEN}[✓] Virtual environment ready${NC}"
}

# Check and bootstrap venv if needed
echo -e "${CYAN}[*] Checking virtual environment...${NC}"
if ! check_venv; then
    bootstrap_venv
else
    echo -e "${GREEN}[✓] Virtual environment OK${NC}"
fi

# Verify dependencies
echo -e "${CYAN}[*] Verifying dependencies...${NC}"
if ! "$VENV_PYTHON" -c "import textual" 2>/dev/null; then
    echo -e "${YELLOW}[!] textual not found, reinstalling...${NC}"
    "$VENV_PIP" install textual --quiet
fi
echo -e "${GREEN}[✓] textual framework OK${NC}"

# Check PBKDF2 cracker modules
if ! "$VENV_PYTHON" -c "from crackers import PBKDF2Cracker, MutationEngine, ContextWordlistGenerator" 2>/dev/null; then
    echo -e "${RED}[✗] WIFUCKER crackers module not found${NC}"
    echo -e "${YELLOW}[!] Make sure you're running this from the WIFUCKER directory${NC}"
    exit 1
fi
echo -e "${GREEN}[✓] PBKDF2 cracker modules loaded${NC}"

# List available features
echo ""
echo -e "${CYAN}[*] Available Features:${NC}"
echo -e "    ${GREEN}✓${NC} PBKDF2 Password Cracking (dictionary/pattern/context/mutations)"
echo -e "    ${GREEN}✓${NC} rockyou.txt integration (14.3M passwords)"
echo -e "    ${GREEN}✓${NC} Multi-threaded dictionary attacks (up to 2.8M/sec)"
echo -e "    ${GREEN}✓${NC} Rule-based password mutations"
echo -e "    ${GREEN}✓${NC} Context-aware wordlist generation"
echo -e "    ${GREEN}✓${NC} Real-time progress monitoring"

# Check rockyou.txt
ROCKYOU_PATH="$HOME/rockyou/rockyou.txt"
if [ -f "$ROCKYOU_PATH" ]; then
    SIZE=$(du -h "$ROCKYOU_PATH" | awk '{print $1}')
    COUNT=$(wc -l < "$ROCKYOU_PATH")
    echo -e "    ${GREEN}✓${NC} rockyou.txt found (${SIZE}, ${COUNT} passwords)"
else
    echo -e "    ${YELLOW}⚠${NC} rockyou.txt not found (download from Tools tab)"
fi

echo ""
echo -e "${CYAN}[*] Setting QUANTUM Clearance (Layer 9)...${NC}"

# Set maximum clearance (Layer 9 - QUANTUM) before launch
CLEARANCE_SCRIPT="$SCRIPTS_DIR/set_max_clearance.py"
if [ -f "$CLEARANCE_SCRIPT" ]; then
    "$VENV_PYTHON" "$CLEARANCE_SCRIPT" > /dev/null 2>&1 || true
    echo -e "${GREEN}[✓] QUANTUM clearance set (Layer 9)${NC}"
else
    echo -e "${YELLOW}[!] Clearance script not found, continuing...${NC}"
fi

echo ""
echo -e "${CYAN}[*] Launching WIFUCKER Unified TUI with full Layer 9 permissions...${NC}"
echo ""

# Run the unified TUI using venv python
cd "$SCRIPT_DIR"

# Handle sudo scenarios
if [ -n "${SUDO_USER:-}" ]; then
    echo -e "${YELLOW}[!] Running with sudo detected${NC}"
    # When using sudo, preserve environment with -E flag
    # Check if venv is accessible
    if [ ! -f "$VENV_PYTHON" ] || [ ! -x "$VENV_PYTHON" ]; then
        echo -e "${RED}[✗] Virtual environment not accessible${NC}"
        echo -e "${YELLOW}[!] If you need sudo, use: sudo -E $0${NC}"
        echo -e "${YELLOW}[!] Or run without sudo: $0${NC}"
        exit 1
    fi
    # Ensure venv is readable
    if [ ! -r "$VENV_PYTHON" ]; then
        chmod -R u+rX "$VENV_DIR" 2>/dev/null || {
            echo -e "${RED}[✗] Cannot access virtual environment${NC}"
            echo -e "${YELLOW}[!] Try: sudo -E $0${NC}"
            exit 1
        }
    fi
fi

# Execute using venv python
exec "$VENV_PYTHON" "$TUI_SCRIPT" "$@"
