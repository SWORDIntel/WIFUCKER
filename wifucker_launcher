#!/bin/bash
#
# WIFUCKER Unified Launcher
# Integrated WiFi + PBKDF2 + Steganography cracking platform
#

set -euo pipefail

SCRIPT_DIR="$(pwd)"
SCRIPTS_DIR="$SCRIPT_DIR/wifucker_pkg/scripts"
TUI_SCRIPT="$SCRIPT_DIR/wifucker_pkg/wifucker_unified_tui.py"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Banner
echo -e "${CYAN}"
cat << "EOF"
╔═══════════════════════════════════════════════════════════════╗
║                                                               ║
║          WIFUCKER - Unified Cracking Platform v2.0            ║
║                                                               ║
║  WiFi WPA/WPA2 + PBKDF2 + Steganography Password Cracking    ║
║                                                               ║
║  Integrated with:                                             ║
║  • Multi-threaded PBKDF2 dictionary attacks                   ║
║  • Context-aware password generation                          ║
║  • Rule-based mutation engine                                 ║
║  • rockyou wordlist integration (14.3M passwords)             ║
║  • Hardware acceleration detection (NPU/NCS2/GPU)             ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝
EOF
echo -e "${NC}"

# Check Python version
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}[✗] Python 3 not found${NC}"
    exit 1
fi

PYTHON_VERSION=$(python3 --version | awk '{print $2}')
echo -e "${GREEN}[✓] Python ${PYTHON_VERSION}${NC}"

# Virtual environment setup
VENV_DIR="$SCRIPT_DIR/venv"
REQUIREMENTS_FILE="$SCRIPT_DIR/requirements.txt"
VENV_PYTHON="$VENV_DIR/bin/python3"
VENV_PIP="$VENV_DIR/bin/pip"

# Function to check if venv is valid
check_venv() {
    if [ -f "$VENV_PYTHON" ] && [ -x "$VENV_PYTHON" ]; then
        # Test if venv python works and can import textual
        if "$VENV_PYTHON" -c "import textual" 2>/dev/null; then
            return 0
        fi
    fi
    return 1
}

# Bootstrap virtual environment
bootstrap_venv() {
    echo -e "${CYAN}[*] Bootstrapping virtual environment...${NC}"
    echo -e "${CYAN}[*] This will create a clean Python environment for WIFUCKER${NC}"

    # Remove broken venv if it exists
    if [ -d "$VENV_DIR" ]; then
        echo -e "${YELLOW}[!] Removing existing virtual environment...${NC}"
        rm -rf "$VENV_DIR"
    fi

    # Create new venv
    echo -e "${CYAN}[*] Creating fresh virtual environment at $VENV_DIR${NC}"
    python3 -m venv "$VENV_DIR" || {
        echo -e "${RED}[✗] Failed to create virtual environment${NC}"
        exit 1
    }
    echo -e "${GREEN}[✓] Virtual environment created successfully${NC}"

    # Upgrade pip
    echo -e "${CYAN}[*] Upgrading pip to latest version...${NC}"
    "$VENV_PIP" install --upgrade pip --verbose

    # Install dependencies
    if [ -f "$REQUIREMENTS_FILE" ]; then
        echo -e "${CYAN}[*] Installing dependencies from requirements.txt...${NC}"
        echo -e "${CYAN}[*] This may take a few minutes. You will see detailed package installation progress.${NC}"
        set +e
        "$VENV_PIP" install -r "$REQUIREMENTS_FILE" --verbose
        INSTALL_STATUS=$?
        set -e
        if [ $INSTALL_STATUS -ne 0 ]; then
            echo -e "${YELLOW}[!] Some dependencies may have failed, continuing...${NC}"
        fi
    else
        echo -e "${YELLOW}[!] requirements.txt not found, installing minimal dependencies...${NC}"
        "$VENV_PIP" install textual rich --verbose
    fi

    echo -e "${GREEN}[✓] Virtual environment bootstrap complete${NC}"
    echo -e "${GREEN}[✓] All dependencies installed successfully${NC}"
}

# Check and bootstrap venv if needed
echo -e "${CYAN}[*] Checking virtual environment...${NC}"
if ! check_venv; then
    echo -e "${YELLOW}[!] Virtual environment check failed, bootstrapping...${NC}"
    bootstrap_venv
else
    echo -e "${GREEN}[✓] Virtual environment OK${NC}"
fi

# Verify dependencies
echo -e "${CYAN}[*] Verifying dependencies...${NC}"
echo -e "${CYAN}[*] Current directory: $(pwd)${NC}"
echo -e "${CYAN}[*] SCRIPT_DIR: $SCRIPT_DIR${NC}"
if ! "$VENV_PYTHON" -c "import textual" 2>/dev/null; then
    echo -e "${YELLOW}[!] textual not found, reinstalling...${NC}"
    "$VENV_PIP" install textual --quiet
fi
echo -e "${GREEN}[✓] textual framework OK${NC}"

# Check evil twin dependencies
echo -e "${CYAN}[*] Checking evil twin dependencies...${NC}"
EVIL_TWIN_DEPS_OK=true

# Check system tools
for tool in hostapd dnsmasq aircrack-ng reaver bully pixiewps arp-scan; do
    if ! command -v "$tool" &> /dev/null; then
        EVIL_TWIN_DEPS_OK=false
        break
    fi
done

# Check Python modules
if ! "$VENV_PYTHON" -c "import scapy, netifaces, psutil, flask" 2>/dev/null; then
    EVIL_TWIN_DEPS_OK=false
fi

if [ "$EVIL_TWIN_DEPS_OK" = true ]; then
    echo -e "${GREEN}[✓] Evil twin dependencies OK${NC}"
else
    echo -e "${YELLOW}[!] Evil twin dependencies missing${NC}"
    echo -e "${CYAN}[*] Run: sudo ./bootstrap_evil_twin.sh${NC}"
    echo -e "${CYAN}[*] (Requires root for system package installation)${NC}"
fi

# Check PBKDF2 cracker modules
echo -e "${CYAN}[*] Checking WIFUCKER modules...${NC}"
echo -e "${CYAN}[*] Checking PYTHONPATH: $SCRIPT_DIR${NC}"
if ! PYTHONPATH="$SCRIPT_DIR" "$VENV_PYTHON" -c "from wifucker_pkg.crackers import PBKDF2Cracker, MutationEngine, ContextWordlistGenerator" 2>/dev/null; then
    echo -e "${RED}[✗] WIFUCKER crackers module not found${NC}"
    echo -e "${YELLOW}[!] Make sure you're running this from the WIFUCKER directory${NC}"
    echo -e "${YELLOW}[!] PYTHONPATH was: $SCRIPT_DIR${NC}"
    exit 1
fi
echo -e "${GREEN}[✓] PBKDF2 cracker modules loaded${NC}"

# List available features
echo ""
echo -e "${CYAN}[*] Available Features:${NC}"
echo -e "    ${GREEN}✓${NC} PBKDF2 Password Cracking (dictionary/pattern/context/mutations)"
echo -e "    ${GREEN}✓${NC} rockyou.txt integration (14.3M passwords)"
echo -e "    ${GREEN}✓${NC} Multi-threaded dictionary attacks (up to 2.8M/sec)"
echo -e "    ${GREEN}✓${NC} Rule-based password mutations"
echo -e "    ${GREEN}✓${NC} Context-aware wordlist generation"
echo -e "    ${GREEN}✓${NC} Real-time progress monitoring"
echo -e "    ${GREEN}✓${NC} UK Router WPS attacks (Virgin, BT, EE)"
echo -e "    ${GREEN}✓${NC} Evil Twin Suite with captive portals"
echo -e "    ${GREEN}✓${NC} Advanced WPS methods (Small DH Key, Registrar Disclosure, EAP Injection)"

# Check rockyou.txt
ROCKYOU_PATH="$HOME/rockyou/rockyou.txt"
if [ -f "$ROCKYOU_PATH" ]; then
    SIZE=$(du -h "$ROCKYOU_PATH" | awk '{print $1}')
    COUNT=$(wc -l < "$ROCKYOU_PATH")
    echo -e "    ${GREEN}✓${NC} rockyou.txt found (${SIZE}, ${COUNT} passwords)"
else
    echo -e "    ${YELLOW}⚠${NC} rockyou.txt not found (download from Tools tab)"
fi

echo ""
echo -e "${CYAN}[*] Setting QUANTUM Clearance (Layer 9)...${NC}"

# Set maximum clearance (Layer 9 - QUANTUM) before launch
CLEARANCE_SCRIPT="$SCRIPTS_DIR/set_max_clearance.py"
if [ -f "$CLEARANCE_SCRIPT" ]; then
    "$VENV_PYTHON" "$CLEARANCE_SCRIPT" > /dev/null 2>&1 || true
    echo -e "${GREEN}[✓] QUANTUM clearance set (Layer 9)${NC}"
else
    echo -e "${YELLOW}[!] Clearance script not found, continuing...${NC}"
fi

echo ""
echo -e "${CYAN}[*] Launching WIFUCKER Unified TUI with full Layer 9 permissions...${NC}"
echo ""

    # Run the unified TUI using venv python
    cd "$SCRIPT_DIR"

    # Handle sudo scenarios
    if [ -n "${SUDO_USER:-}" ]; then
        echo -e "${YELLOW}[!] Running with sudo detected${NC}"
        # When using sudo, preserve environment with -E flag
        # Check if venv is accessible
        if [ ! -f "$VENV_PYTHON" ] || [ ! -x "$VENV_PYTHON" ]; then
            echo -e "${RED}[✗] Virtual environment not accessible${NC}"
            echo -e "${YELLOW}[!] If you need sudo, use: sudo -E $0${NC}"
            echo -e "${YELLOW}[!] Or run without sudo: $0${NC}"
            exit 1
        fi
        # Ensure venv is readable
        if [ ! -r "$VENV_PYTHON" ]; then
            chmod -R u+rX "$VENV_DIR" 2>/dev/null || {
                echo -e "${RED}[✗] Cannot access virtual environment${NC}"
                echo -e "${YELLOW}[!] Try: sudo -E $0${NC}"
                exit 1
            }
        fi
    fi

    # Check for CLI mode (first argument is a command)
    if [ $# -gt 0 ] && [ "$1" != "--help" ] && [ "$1" != "-h" ]; then
        # Check if it's a known CLI command
        CLI_COMMANDS="parse crack generate download devices benchmark audit interfaces optimize monitor capture surveillance"
        if echo "$CLI_COMMANDS" | grep -q "\b$1\b"; then
            # Route to CLI interface
            CLI_SCRIPT="$SCRIPT_DIR/wifucker_pkg/scripts/wifi_cli.py"
            if [ -f "$CLI_SCRIPT" ]; then
                exec PYTHONPATH="$SCRIPT_DIR" "$VENV_PYTHON" -m wifucker_pkg.scripts.wifi_cli "$@"
            else
                echo -e "${RED}[✗] CLI script not found: $CLI_SCRIPT${NC}"
                echo -e "${YELLOW}[!] Falling back to TUI mode${NC}"
                exec PYTHONPATH="$SCRIPT_DIR" "$VENV_PYTHON" -m wifucker_pkg "$@"
            fi
        else
            # Unknown command, pass to TUI (might be TUI arguments)
            exec PYTHONPATH="$SCRIPT_DIR" "$VENV_PYTHON" -m wifucker_pkg "$@"
        fi
    else
        # No arguments or help requested - launch TUI
        exec PYTHONPATH="$SCRIPT_DIR" "$VENV_PYTHON" -m wifucker_pkg "$@"
    fi
